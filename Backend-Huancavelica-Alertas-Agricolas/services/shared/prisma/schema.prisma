generator client {
  provider      = "prisma-client-js"
  // Ensure Prisma generates query engines compatible with common Linux runtimes
  // Include linux-musl (alpine) and Debian/OpenSSL variants used by slim images
  binaryTargets = ["native", "linux-musl", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid())
  nombre          String?
  email           String?         @unique
  telefono        String          @unique
  password        String
  ciudad          String?
  zona            String?
  activo          Boolean         @default(true)
  prefs           String?
  roles           String          @default("[\"usuario\"]")
  alertasReportadas Int           @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  alerts          Alert[]
  logs            Log[]
  notifications   Notification[]
  verificationCodes VerificationCode[]
}

model Alert {
  id            String   @id @default(uuid())
  titulo        String
  descripcion   String?
  tipo          String?
  severidad     String?
  prioridad     String   @default("media")
  estado        String   @default("activa")
  ubicacion     String?
  zona          String?
  reportadoPor  String?
  tiempoRespuesta Int?
  activa        Boolean  @default(true)
  fecha         DateTime @default(now())
  metadata      String?
  user          User?    @relation(fields: [userId], references: [id])
  userId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Log {
  id String @id @default(uuid())
  nivel String
  mensaje String
  contexto String?
  createdAt DateTime @default(now())
  user User? @relation(fields: [userId], references: [id])
  userId String?
}

// Metadata for uploaded training datasets (Excel/CSV)
model TrainingDataset {
  id        String   @id @default(uuid())
  fileName  String
  path      String
  columns   Json
  rowCount  Int
  metadata  Json?
  createdAt DateTime @default(now())
}

model Zone {
  id            String   @id @default(uuid())
  nombre        String   @unique
  region        String
  alertasActivas Int     @default(0)
  poblacion     Int      @default(0)
  latitud       Float
  longitud      Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  tipo      String
  titulo    String
  mensaje   String
  leido     Boolean  @default(false)
  prioridad String   @default("media")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, leido])
}

model WeatherData {
  id            String   @id @default(uuid())
  zona          String
  temperatura   Float
  humedad       Float
  precipitacion Float
  velocidadViento Float
  descripcion   String?
  fecha         DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([zona, fecha])
}

model VerificationCode {
  id        String   @id @default(uuid())
  codigo    String
  tipo      String   // 'sms' | 'email'
  usado     Boolean  @default(false)
  expiraEn  DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())

  @@index([codigo, usado, expiraEn])
}

model Recommendation {
  id          String   @id @default(uuid())
  tipoAlerta  String
  titulo      String
  descripcion String
  prioridad   String
  orden       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tipoAlerta])
}

model Report {
  id              String   @id @default(uuid())
  cultivo         String
  fechaInicio     DateTime
  fechaFin        DateTime
  temperaturaPromedio Float?
  precipitacionTotal  Float?
  humedadPromedio Float?
  totalAlertas    Int      @default(0)
  archivoUrl      String?
  generadoPor     String?
  createdAt       DateTime @default(now())

  @@index([cultivo, fechaInicio, fechaFin])
}
