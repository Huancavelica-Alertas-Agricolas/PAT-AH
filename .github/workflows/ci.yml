name: CI

on:
  push:
    branches: [ main, circleci-project-setup ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies for ai-service (needed by rest-service e2e)
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/ai-service
        run: |
          echo "Installing dependencies for ai-service..."
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps || true

      - name: Run tests for rest-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Installing dependencies for rest-service..."
          npm ci --legacy-peer-deps
          echo "Running tests for rest-service..."
          npm test

      - name: Run tests for weather-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/weather-service
        run: |
          echo "Checking for weather-service test files..."
          # Enable globstar and check for any *.spec.js or *.spec.ts files
          shopt -s globstar || true
          if compgen -G "**/*.spec.*" > /dev/null; then
            echo "Test files found, installing deps and running tests..."
            npm ci --legacy-peer-deps
            npm test
          else
            echo "No test files found, skipping weather-service tests."
          fi

      - name: Run tests for ai-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/ai-service
        run: |
          echo "Installing dependencies for ai-service..."
          npm ci --legacy-peer-deps
          echo "Building ai-service image for integration tests..."
          docker build -t pat-ah/ai-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/ai-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas || true
          echo "Running tests for ai-service (unit + container E2E)..."
          npm test || ( echo "ai-service tests failed" && exit 1 )
        timeout-minutes: 30

      - name: Run tests for frontend
        working-directory: Frontend-Huancavelica-Alertas-Agricolas
        run: |
          echo "Installing dependencies for frontend..."
          npm ci --legacy-peer-deps
          echo "Running frontend build..."
          npm run build || echo "Build failed or not configured"

      - name: Run integration tests (rest-service) using docker-compose
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Starting docker-compose test stack..."
          docker-compose -f docker-compose.test.yml up -d
          echo "Running integration commands inside runner..."
          docker-compose -f docker-compose.test.yml run --rm runner sh -c "npm ci --legacy-peer-deps; npx prisma generate; npx prisma db push; npm test -- test/integration/user.integration.spec.js --runInBand"
          echo "Tearing down docker-compose test stack..."
          docker-compose -f docker-compose.test.yml down -v

      - name: Build Docker images (optional)
        run: |
          echo "Building Docker images for services with Dockerfile"
          docker --version || true
          docker build -t pat-ah/rest-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/rest-service || true
          docker build -t pat-ah/ai-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/ai-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/ai-service || true
          docker build -t pat-ah/weather-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/weather-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/weather-service || true
          docker build -t pat-ah/frontend:ci -f Frontend-Huancavelica-Alertas-Agricolas/Dockerfile Frontend-Huancavelica-Alertas-Agricolas || true

      - name: Upload test results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            Backend-Huancavelica-Alertas-Agricolas/services/rest-service/jest.config.json
            Backend-Huancavelica-Alertas-Agricolas/services/weather-service/jest.config.json
