name: CI

on:
  push:
    branches: [ dev, circleci-project-setup ]
  pull_request:
    branches: [ dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies for all services (backend + frontend)
        run: |
          echo "Installing dependencies for all services..."
          SERVICES=(
            "Backend-Huancavelica-Alertas-Agricolas/services/auth-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/users-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/rest-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/weather-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ai-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ingest-service"
            "Frontend-Huancavelica-Alertas-Agricolas"
          )
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              echo "--- Installing dependencies for $pkg ---"
              if [ -f "$pkg/package-lock.json" ]; then
                npm ci --prefix "$pkg" --legacy-peer-deps || npm install --prefix "$pkg" --legacy-peer-deps
              else
                npm install --prefix "$pkg" --legacy-peer-deps
              fi
            fi
          done

      - name: Run npm audit for all services (produce reports)
        run: |
          echo "Running npm audit for services..."
          mkdir -p "$GITHUB_WORKSPACE/audit-reports"
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              name=$(basename "$pkg")
              echo "--- npm audit: $pkg -> $name-audit.json ---"
              (cd "$pkg" && npm audit --json > "$GITHUB_WORKSPACE/audit-reports/$name-audit.json") || echo "{}" > "$GITHUB_WORKSPACE/audit-reports/$name-audit.json"
            fi
          done

      - name: Run ESLint where configured
        run: |
          echo "Running ESLint for packages that declare eslint config..."
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              if [ -f "$pkg/.eslintrc" ] || [ -f "$pkg/.eslintrc.js" ] || [ -f "$pkg/.eslintrc.json" ] || grep -q "eslintConfig" "$pkg/package.json" 2>/dev/null; then
                echo "--- ESLint: $pkg ---"
                npx eslint "$pkg" --ext .js,.ts || true
              fi
            fi
          done

      - name: Run tests for rest-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Running tests for rest-service..."
          npm test -- --passWithNoTests

      - name: Run tests for weather-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/weather-service
        run: |
          echo "Running tests for weather-service..."
          npm test -- --passWithNoTests

      - name: Run tests for notification-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/notification-service
        run: |
          echo "Running tests for notification-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for users-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/users-service
        run: |
          echo "Running tests for users-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for alert-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/alert-service
        run: |
          echo "Running tests for alert-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for ai-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/ai-service
        run: |
          echo "Building ai-service image for integration tests (service context)..."
          # Use the service directory as the docker build context so paths like trained-models exist relative to Dockerfile
          docker build -t pat-ah/ai-service:ci -f Dockerfile . || true
          echo "Running tests for ai-service (unit + container E2E)..."
          npm test -- --passWithNoTests || ( echo "ai-service tests failed" && exit 1 )
        timeout-minutes: 30

      - name: Run tests for frontend
        working-directory: Frontend-Huancavelica-Alertas-Agricolas
        run: |
          echo "Running frontend build/tests..."
          npm test -- --passWithNoTests || true
          npm run build || echo "Build failed or not configured"

      - name: Run integration tests (rest-service) using docker-compose
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Starting docker-compose test stack..."
          # Ensure docker compose command is available on ubuntu runners
          echo "Ensuring docker-compose is installed (plugin + compatibility)..."
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin || true
          # Create compatibility symlink if binary available as CLI plugin
          if [ -f /usr/libexec/docker/cli-plugins/docker-compose ]; then
            sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
          fi
          # Fallback: try python/pip installation (less preferred)
          if ! command -v docker-compose >/dev/null 2>&1; then
            echo "docker-compose not found, trying pip install..."
            python3 -m pip install --user docker-compose || true
            export PATH="$HOME/.local/bin:$PATH"
          fi
          docker-compose -f docker-compose.test.yml up -d
          echo "Running integration commands inside runner..."
          docker-compose -f docker-compose.test.yml run --rm runner sh -c "npm ci --legacy-peer-deps; npx prisma generate; npx prisma db push; npm test -- test/integration/user.integration.spec.js --runInBand"
          echo "Tearing down docker-compose test stack..."
          docker-compose -f docker-compose.test.yml down -v

      - name: Build Docker images (optional)
        run: |
          echo "Building Docker images for services with Dockerfile"
          docker --version || true
          docker build -t pat-ah/rest-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/rest-service || true
          docker build -t pat-ah/ai-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/ai-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/ai-service || true
          docker build -t pat-ah/weather-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/weather-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/weather-service || true
          docker build -t pat-ah/frontend:ci -f Frontend-Huancavelica-Alertas-Agricolas/Dockerfile Frontend-Huancavelica-Alertas-Agricolas || true

      - name: Upload test results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            Backend-Huancavelica-Alertas-Agricolas/services/rest-service/jest.config.json
            Backend-Huancavelica-Alertas-Agricolas/services/weather-service/jest.config.json

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: audit-reports

  dast:
    name: DAST - OWASP ZAP baseline scan
    runs-on: ubuntu-latest
    needs: test
    env:
      # Comma-separated severities that should make the job fail (case-insensitive)
      ZAP_FAIL_SEVERITIES: "High,Critical"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure docker-compose and docker available
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin || true
          if [ -f /usr/libexec/docker/cli-plugins/docker-compose ]; then
            sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
          fi
          docker --version || true

      - name: Start test stack for DAST
        run: |
          echo "Starting docker-compose test stack for DAST..."
          docker-compose -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/docker-compose.test.yml up -d || docker-compose -f docker-compose.test.yml up -d || true

      - name: Wait for target to be healthy
        run: |
          TARGET_URL=http://localhost:3003/healthz
          echo "Waiting for $TARGET_URL to respond (timeout 120s)..."
          for i in $(seq 1 24); do
            if curl -sSf $TARGET_URL >/dev/null 2>&1; then
              echo "Target healthy"
              exit 0
            fi
            sleep 5
          done
          echo "Target did not become healthy" && exit 1

      - name: Run OWASP ZAP baseline scan (container, host network)
        run: |
          echo "Running OWASP ZAP baseline scan against http://localhost:3003"
          # generate both HTML and JSON reports (-r html, -J json)
          docker run --rm --network host -v $PWD:/zap/wrk/:rw owasp/zap2docker-stable zap-baseline.py -t http://localhost:3003 -r zap-report.html -J zap-report.json || true

      - name: Analyze ZAP JSON and fail on configured severities
        if: always()
        run: |
          echo "Inspecting zap-report.json for severities in $ZAP_FAIL_SEVERITIES..."
          python3 - <<'PY'
import json,sys,os
path='zap-report.json'
if not os.path.exists(path):
    print('zap-report.json not found, skipping fail-on-alerts check')
    sys.exit(0)
with open(path,'r',encoding='utf-8') as f:
    try:
        j=json.load(f)
    except Exception as e:
        print('Failed to parse zap-report.json:',e)
        sys.exit(0)

severities_env = os.environ.get('ZAP_FAIL_SEVERITIES','High,Critical')
severities = set([s.strip().lower() for s in severities_env.split(',') if s.strip()])
print('Configured fail severities:', severities)

def scan(obj):
    # Prefer explicit 'risk' fields typical in ZAP JSON
    if isinstance(obj, dict):
        if 'risk' in obj and isinstance(obj['risk'], str):
            if obj['risk'].strip().lower() in severities:
                return True, ('risk', obj['risk'], obj)
        for v in obj.values():
            found = scan(v)
            if found[0]:
                return found
    elif isinstance(obj, list):
        for item in obj:
            found = scan(item)
            if found[0]:
                return found
    elif isinstance(obj, str):
        low = obj.lower()
        for sev in severities:
            if sev in low:
                return True, (None, obj, obj)
    return (False, None)

found = scan(j)
if found[0]:
    print('Failing build due to alert:', found[1])
    sys.exit(1)
else:
    print('No configured-severity alerts found in zap-report.json')
    sys.exit(0)
PY

      - name: Upload ZAP report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap-report.html
            zap-report.json

      - name: Tear down docker-compose test stack
        if: always()
        run: |
          docker-compose -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/docker-compose.test.yml down -v || docker-compose -f docker-compose.test.yml down -v || true
