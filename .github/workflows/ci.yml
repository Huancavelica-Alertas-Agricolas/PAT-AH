name: CI

on:
  push:
    branches: [ dev, circleci-project-setup, dev-monitoring-testing ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:
    inputs:
      coverage_threshold:
        description: 'Coverage threshold percent (integer) to override default in CI'
        required: false
        default: '70'
      coverage_notification:
        description: 'Coverage threshold for notification-service (optional)'
        required: false
        default: ''
      coverage_alert:
        description: 'Coverage threshold for alert-service (optional)'
        required: false
        default: ''
      coverage_weather:
        description: 'Coverage threshold for weather-service (optional)'
        required: false
        default: ''
      coverage_ai:
        description: 'Coverage threshold for ai-service (optional)'
        required: false
        default: ''
      coverage_ingest:
        description: 'Coverage threshold for ingest-service (optional)'
        required: false
        default: ''
      coverage_users:
        description: 'Coverage threshold for users-service (optional)'
        required: false
        default: ''
      coverage_rest:
        description: 'Coverage threshold for rest-service (optional)'
        required: false
        default: ''

env:
  COVERAGE_THRESHOLD: 70

permissions:
  contents: read
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies for all services (backend + frontend)
        run: |
          echo "Installing dependencies for all services..."
          SERVICES=(
            "Backend-Huancavelica-Alertas-Agricolas/services/auth-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/users-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/rest-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/weather-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ai-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ingest-service"
            "Frontend-Huancavelica-Alertas-Agricolas"
          )
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              echo "--- Installing dependencies for $pkg ---"
              if [ -f "$pkg/package-lock.json" ]; then
                npm ci --prefix "$pkg" --legacy-peer-deps || npm install --prefix "$pkg" --legacy-peer-deps
              else
                npm install --prefix "$pkg" --legacy-peer-deps
              fi
            fi
          done

      - name: Run npm audit for all services (produce reports)
        run: |
          echo "Running npm audit for services..."
          mkdir -p "$GITHUB_WORKSPACE/audit-reports"
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              name=$(basename "$pkg")
              echo "--- npm audit: $pkg -> $name-audit.json ---"
              (cd "$pkg" && npm audit --json > "$GITHUB_WORKSPACE/audit-reports/$name-audit.json") || echo "{}" > "$GITHUB_WORKSPACE/audit-reports/$name-audit.json"
            fi
          done

      - name: Check npm audit reports for High/Critical vulnerabilities
        if: always()
        run: |
          echo "Checking npm audit reports for High/Critical vulnerabilities..."
          set -e
          echo "AUDIT_HAS_FINDINGS=0" >> $GITHUB_ENV
          > audit-findings-summary.txt
          for f in "$GITHUB_WORKSPACE"/audit-reports/*.json; do
            if [ -f "$f" ]; then
              echo "Inspecting $f"
              high_count=0
              crit_count=0
              # Try metadata.vulnerabilities first (npm v7+), fallback to advisories
              if jq -e '.metadata.vulnerabilities // empty' "$f" >/dev/null 2>&1; then
                high_count=$(jq '.metadata.vulnerabilities.high // 0' "$f") || true
                crit_count=$(jq '.metadata.vulnerabilities.critical // 0' "$f") || true
              else
                cnt=$(jq '[.advisories[]? | select(.severity=="high" or .severity=="critical")] | length' "$f" 2>/dev/null || echo 0)
                high_count=$cnt
                crit_count=0
              fi
              total=$((high_count + crit_count)) || true
              if [ "$total" -gt 0 ]; then
                echo "Found $total high/critical vulnerabilities in $f"
                echo "$f: $total" >> audit-findings-summary.txt
                echo "AUDIT_HAS_FINDINGS=1" >> $GITHUB_ENV
              fi
            fi
          done
          if [ -s audit-findings-summary.txt ]; then
            echo "Summary of audit findings:" && cat audit-findings-summary.txt
          else
            echo "No high/critical npm audit issues found."
          fi

      - name: Create GitHub issue for npm audit findings
        if: env.AUDIT_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'audit-findings-summary.txt'
            let body = `Automated report: npm audit found High/Critical vulnerabilities in this run (${process.env.GITHUB_RUN_ID}).\n\n()`
            if (fs.existsSync(path)) {
              body += 'Summary:\n\n' + fs.readFileSync(path, 'utf8') + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: npm audit High/Critical findings - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail CI due to high/critical npm audit issues
        if: env.AUDIT_HAS_FINDINGS == '1'
        run: |
          echo "Failing CI due to high/critical npm audit issues (see created issue and audit-reports artifact)."
          exit 1

      - name: Run ESLint where configured
        run: |
          echo "Running ESLint for packages that declare eslint config..."
          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              if [ -f "$pkg/.eslintrc" ] || [ -f "$pkg/.eslintrc.js" ] || [ -f "$pkg/.eslintrc.json" ] || grep -q "eslintConfig" "$pkg/package.json" 2>/dev/null; then
                echo "--- ESLint: $pkg ---"
                npx eslint "$pkg" --ext .js,.ts || true
              fi
            fi
          done

      - name: Run tests for rest-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Running tests for rest-service..."
          npm test -- --passWithNoTests

      - name: Run tests for weather-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/weather-service
        run: |
          echo "Running tests for weather-service..."
          npm test -- --passWithNoTests

      - name: Run tests for notification-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/notification-service
        run: |
          echo "Running tests for notification-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for users-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/users-service
        run: |
          echo "Running tests for users-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for alert-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/alert-service
        run: |
          echo "Running tests for alert-service..."
          npm test -- --passWithNoTests || true

      - name: Run tests for ai-service
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/ai-service
        run: |
          echo "Building ai-service image for integration tests (service context)..."
          # Use the service directory as the docker build context so paths like trained-models exist relative to Dockerfile
          docker build -t pat-ah/ai-service:ci -f Dockerfile . || true
          echo "Running tests for ai-service (unit + container E2E)..."
          npm test -- --passWithNoTests || ( echo "ai-service tests failed" && exit 1 )
        timeout-minutes: 30

      - name: Run tests for frontend
        working-directory: Frontend-Huancavelica-Alertas-Agricolas
        run: |
          echo "Running frontend build/tests..."
          # Prefer Vitest when present so coverage/coverage-summary.json is produced
          if [ -f package.json ] && grep -q "vitest" package.json; then
            echo "Detected Vitest; running vitest with coverage"
            npx vitest run --coverage || true
          elif [ -f package.json ] && grep -q '"test:cov"' package.json; then
            echo "Detected test:cov script; running npm run test:cov"
            npm run test:cov || true
          else
            echo "Falling back to npm test"
            npm test -- --passWithNoTests || true
          fi
          npm run build || echo "Build failed or not configured"

      - name: Run integration tests (rest-service) using docker-compose
        working-directory: Backend-Huancavelica-Alertas-Agricolas/services/rest-service
        run: |
          echo "Starting docker-compose test stack..."
          # Ensure docker compose command is available on ubuntu runners
          echo "Ensuring docker-compose is installed (plugin + compatibility)..."
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin || true
          # Create compatibility symlink if binary available as CLI plugin
          if [ -f /usr/libexec/docker/cli-plugins/docker-compose ]; then
            sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
          fi
          # Fallback: try python/pip installation (less preferred)
          if ! command -v docker-compose >/dev/null 2>&1; then
            echo "docker-compose not found, trying pip install..."
            python3 -m pip install --user docker-compose || true
            export PATH="$HOME/.local/bin:$PATH"
          fi
          docker-compose -f docker-compose.test.yml up -d
          echo "Running integration commands inside runner..."
          docker-compose -f docker-compose.test.yml run --rm runner sh -c "npm ci --legacy-peer-deps; npx prisma generate; npx prisma db push; npm test -- test/integration/user.integration.spec.js --runInBand"
          echo "Tearing down docker-compose test stack..."
          docker-compose -f docker-compose.test.yml down -v

      - name: Build Docker images (optional)
        run: |
          echo "Building Docker images for services with Dockerfile"
          docker --version || true
          docker build -t pat-ah/rest-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/rest-service || true
          docker build -t pat-ah/ai-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/ai-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/ai-service || true
          docker build -t pat-ah/weather-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/weather-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/weather-service || true
          docker build -t pat-ah/frontend:ci -f Frontend-Huancavelica-Alertas-Agricolas/Dockerfile Frontend-Huancavelica-Alertas-Agricolas || true
          # Also build other backend service images that will be scanned by Trivy
          docker build -t pat-ah/ingest-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/ingest-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/ingest-service || true
          docker build -t pat-ah/notification-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/notification-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/notification-service || true
          docker build -t pat-ah/auth-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/auth-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/auth-service || true
          docker build -t pat-ah/users-service:ci -f Backend-Huancavelica-Alertas-Agricolas/services/users-service/Dockerfile Backend-Huancavelica-Alertas-Agricolas/services/users-service || true

      - name: Scan built Docker image with Trivy (rest-service)
        if: always()
        run: |
          echo "Scanning pat-ah/rest-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-rest-service.json --severity CRITICAL,HIGH pat-ah/rest-service:ci || true

      - name: Upload trivy report (rest-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-rest-report
          path: trivy-rest-service.json

      - name: Analyze Trivy findings (rest-service)
        if: always()
        run: |
          echo "Analyzing trivy-rest-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-rest-service.json ]; then
            echo "trivy-rest-service.json not found; skipping trivy analysis";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-rest-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-rest-service.json"
            echo "TRIVY_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-rest-service.json > trivy-rest-summary.json || true
            echo "Wrote trivy-rest-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for rest-service."
          fi

      - name: Create GitHub issue for Trivy findings (rest-service)
        if: env.TRIVY_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-rest-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the rest-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (rest-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (rest-service)
        if: env.TRIVY_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in rest-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for ai-service ---
      - name: Scan built Docker image with Trivy (ai-service)
        if: always()
        run: |
          echo "Scanning pat-ah/ai-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-ai-service.json --severity CRITICAL,HIGH pat-ah/ai-service:ci || true

      - name: Upload trivy report (ai-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-ai-report
          path: trivy-ai-service.json

      - name: Analyze Trivy findings (ai-service)
        if: always()
        run: |
          echo "Analyzing trivy-ai-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_AI_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-ai-service.json ]; then
            echo "trivy-ai-service.json not found; skipping trivy analysis for ai-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-ai-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-ai-service.json"
            echo "TRIVY_AI_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-ai-service.json > trivy-ai-summary.json || true
            echo "Wrote trivy-ai-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for ai-service."
          fi

      - name: Create GitHub issue for Trivy findings (ai-service)
        if: env.TRIVY_AI_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-ai-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the ai-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (ai-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (ai-service)
        if: env.TRIVY_AI_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in ai-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for weather-service ---
      - name: Scan built Docker image with Trivy (weather-service)
        if: always()
        run: |
          echo "Scanning pat-ah/weather-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-weather-service.json --severity CRITICAL,HIGH pat-ah/weather-service:ci || true

      - name: Upload trivy report (weather-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-weather-report
          path: trivy-weather-service.json

      - name: Analyze Trivy findings (weather-service)
        if: always()
        run: |
          echo "Analyzing trivy-weather-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_WEATHER_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-weather-service.json ]; then
            echo "trivy-weather-service.json not found; skipping trivy analysis for weather-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-weather-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-weather-service.json"
            echo "TRIVY_WEATHER_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-weather-service.json > trivy-weather-summary.json || true
            echo "Wrote trivy-weather-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for weather-service."
          fi

      - name: Create GitHub issue for Trivy findings (weather-service)
        if: env.TRIVY_WEATHER_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-weather-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the weather-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (weather-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (weather-service)
        if: env.TRIVY_WEATHER_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in weather-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for frontend ---
      - name: Scan built Docker image with Trivy (frontend)
        if: always()
        run: |
          echo "Scanning pat-ah/frontend:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-frontend.json --severity CRITICAL,HIGH pat-ah/frontend:ci || true

      - name: Upload trivy report (frontend)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-frontend-report
          path: trivy-frontend.json

      - name: Analyze Trivy findings (frontend)
        if: always()
        run: |
          echo "Analyzing trivy-frontend.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_FRONTEND_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-frontend.json ]; then
            echo "trivy-frontend.json not found; skipping trivy analysis for frontend";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-frontend.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-frontend.json"
            echo "TRIVY_FRONTEND_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-frontend.json > trivy-frontend-summary.json || true
            echo "Wrote trivy-frontend-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for frontend."
          fi

      - name: Create GitHub issue for Trivy findings (frontend)
        if: env.TRIVY_FRONTEND_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-frontend-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the frontend image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (frontend) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (frontend)
        if: env.TRIVY_FRONTEND_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in frontend (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for ingest-service ---
      - name: Scan built Docker image with Trivy (ingest-service)
        if: always()
        run: |
          echo "Scanning pat-ah/ingest-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-ingest-service.json --severity CRITICAL,HIGH pat-ah/ingest-service:ci || true

      - name: Upload trivy report (ingest-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-ingest-report
          path: trivy-ingest-service.json

      - name: Analyze Trivy findings (ingest-service)
        if: always()
        run: |
          echo "Analyzing trivy-ingest-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_INGEST_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-ingest-service.json ]; then
            echo "trivy-ingest-service.json not found; skipping trivy analysis for ingest-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-ingest-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-ingest-service.json"
            echo "TRIVY_INGEST_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-ingest-service.json > trivy-ingest-summary.json || true
            echo "Wrote trivy-ingest-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for ingest-service."
          fi

      - name: Create GitHub issue for Trivy findings (ingest-service)
        if: env.TRIVY_INGEST_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-ingest-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the ingest-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (ingest-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (ingest-service)
        if: env.TRIVY_INGEST_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in ingest-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for notification-service ---
      - name: Scan built Docker image with Trivy (notification-service)
        if: always()
        run: |
          echo "Scanning pat-ah/notification-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-notification-service.json --severity CRITICAL,HIGH pat-ah/notification-service:ci || true

      - name: Upload trivy report (notification-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-notification-report
          path: trivy-notification-service.json

      - name: Analyze Trivy findings (notification-service)
        if: always()
        run: |
          echo "Analyzing trivy-notification-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_NOTIFICATION_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-notification-service.json ]; then
            echo "trivy-notification-service.json not found; skipping trivy analysis for notification-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-notification-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-notification-service.json"
            echo "TRIVY_NOTIFICATION_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-notification-service.json > trivy-notification-summary.json || true
            echo "Wrote trivy-notification-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for notification-service."
          fi

      - name: Create GitHub issue for Trivy findings (notification-service)
        if: env.TRIVY_NOTIFICATION_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-notification-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the notification-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (notification-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (notification-service)
        if: env.TRIVY_NOTIFICATION_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in notification-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for auth-service ---
      - name: Scan built Docker image with Trivy (auth-service)
        if: always()
        run: |
          echo "Scanning pat-ah/auth-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-auth-service.json --severity CRITICAL,HIGH pat-ah/auth-service:ci || true

      - name: Upload trivy report (auth-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-auth-report
          path: trivy-auth-service.json

      - name: Analyze Trivy findings (auth-service)
        if: always()
        run: |
          echo "Analyzing trivy-auth-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_AUTH_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-auth-service.json ]; then
            echo "trivy-auth-service.json not found; skipping trivy analysis for auth-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-auth-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-auth-service.json"
            echo "TRIVY_AUTH_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-auth-service.json > trivy-auth-summary.json || true
            echo "Wrote trivy-auth-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for auth-service."
          fi

      - name: Create GitHub issue for Trivy findings (auth-service)
        if: env.TRIVY_AUTH_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-auth-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the auth-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (auth-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (auth-service)
        if: env.TRIVY_AUTH_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in auth-service (see created issue and trivy artifact)."
          exit 1

      # --- Trivy scan + analysis for users-service ---
      - name: Scan built Docker image with Trivy (users-service)
        if: always()
        run: |
          echo "Scanning pat-ah/users-service:ci with Trivy (image)..."
          echo "Installing Trivy (if missing)..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.39.0 || true
          trivy image --format json -o trivy-users-service.json --severity CRITICAL,HIGH pat-ah/users-service:ci || true

      - name: Upload trivy report (users-service)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-users-report
          path: trivy-users-service.json

      - name: Analyze Trivy findings (users-service)
        if: always()
        run: |
          echo "Analyzing trivy-users-service.json for CRITICAL/HIGH vulnerabilities..."
          set -e
          echo "TRIVY_USERS_HAS_FINDINGS=0" >> $GITHUB_ENV
          if [ ! -f trivy-users-service.json ]; then
            echo "trivy-users-service.json not found; skipping trivy analysis for users-service";
            exit 0
          fi
          cnt=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' trivy-users-service.json 2>/dev/null || echo 0)
          if [ "$cnt" -gt 0 ]; then
            echo "Found $cnt CRITICAL/HIGH vulnerabilities in trivy-users-service.json"
            echo "TRIVY_USERS_HAS_FINDINGS=1" >> $GITHUB_ENV
            jq '[.Results[].Vulnerabilities[]? | {PkgName:.PkgName, InstalledVersion:.InstalledVersion, Severity:.Severity, Title:.Title, VulnerabilityID:.VulnerabilityID}]' trivy-users-service.json > trivy-users-summary.json || true
            echo "Wrote trivy-users-summary.json"
          else
            echo "No CRITICAL/HIGH vulnerabilities found by Trivy for users-service."
          fi

      - name: Create GitHub issue for Trivy findings (users-service)
        if: env.TRIVY_USERS_HAS_FINDINGS == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const path = 'trivy-users-summary.json'
            let body = `Automated report: Trivy found CRITICAL/HIGH vulnerabilities in the users-service image for run ${process.env.GITHUB_RUN_ID}.\n\n`;
            if (fs.existsSync(path)) {
              body += 'Summary (first entries):\n\n' + fs.readFileSync(path, 'utf8').slice(0, 8000) + '\n\n'
            }
            body += `Artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security: Trivy CRITICAL/HIGH findings (users-service) - run ${process.env.GITHUB_RUN_ID}`,
              body: body
            })

      - name: Fail build on Trivy CRITICAL/HIGH findings (users-service)
        if: env.TRIVY_USERS_HAS_FINDINGS == '1'
        run: |
          echo "Failing build due to Trivy CRITICAL/HIGH vulnerabilities in users-service (see created issue and trivy artifact)."
          exit 1

      - name: Upload test results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            Backend-Huancavelica-Alertas-Agricolas/services/rest-service/jest.config.json
            Backend-Huancavelica-Alertas-Agricolas/services/weather-service/jest.config.json

      - name: Run per-service coverage and collect artifacts
        if: always()
        run: |
          echo "Running per-service coverage and collecting artifacts"
          mkdir -p coverage-artifacts || true
          SERVICES=(
            "Backend-Huancavelica-Alertas-Agricolas/services/auth-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/users-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/rest-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/weather-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ai-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/ingest-service"
            "Backend-Huancavelica-Alertas-Agricolas/services/notification-service"
            "Frontend-Huancavelica-Alertas-Agricolas"
          )

          for pkg in "${SERVICES[@]}"; do
            if [ -f "$pkg/package.json" ]; then
              name=$(basename "$pkg")
              echo "--- Service: $pkg -> $name ---"
              mkdir -p "coverage-artifacts/$name"
              (cd "$pkg" && npm ci --no-audit --no-fund) > "coverage-artifacts/${name}-install.log" 2>&1 || \
                (cd "$pkg" && npm install --no-audit --no-fund) >> "coverage-artifacts/${name}-install.log" 2>&1 || true

              # Run coverage script if declared, otherwise run package test with coverage flags
              if grep -q '"test:cov"' "$pkg/package.json"; then
                (cd "$pkg" && npm run test:cov --if-present) > "coverage-artifacts/${name}-test.log" 2>&1 || true
              else
                # Prefer `npm test -- --coverage` so projects using Vitest or Jest both get coverage
                (cd "$pkg" && npm test -- --coverage --coverageReporters=json-summary --runInBand) > "coverage-artifacts/${name}-test.log" 2>&1 || true
              fi

              # Copy coverage dir if exists
              if [ -d "$pkg/coverage" ]; then
                cp -r "$pkg/coverage" "coverage-artifacts/$name/" || true
              elif [ -f "$pkg/coverage/coverage-summary.json" ]; then
                mkdir -p "coverage-artifacts/$name"
                cp "$pkg/coverage/coverage-summary.json" "coverage-artifacts/$name/coverage-summary.json" || true
              else
                echo "Warning: no coverage produced for $name" >> "coverage-artifacts/${name}-test.log"
              fi
            fi
          done

          echo "Listing coverage-artifacts"
          ls -R coverage-artifacts || true

      - name: Upload coverage artifacts (diagnostic)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: coverage-artifacts

      - name: Diagnostic - list coverage summaries
        if: always()
        run: |
          echo "Looking for coverage-summary.json files under coverage-artifacts"
          find coverage-artifacts -type f -name 'coverage-summary.json' -print || true
          echo "Show first 200 lines of each coverage-summary.json (if any)"
          for f in $(find coverage-artifacts -type f -name 'coverage-summary.json' -print || true); do
            echo "--- $f ---"
            head -n 200 "$f" || true
          done

      - name: Collect and upload diagnostic logs
        if: always()
        run: |
          echo "Collecting install/test logs into diagnostics folder"
          mkdir -p diagnostic-logs || true
          # copy any per-service logs from coverage-artifacts
          cp -v coverage-artifacts/*-install.log diagnostic-logs/ 2>/dev/null || true
          cp -v coverage-artifacts/*-test.log diagnostic-logs/ 2>/dev/null || true
        # upload the logs even if empty
      - name: Upload CI diagnostic logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-diagnostics
          path: diagnostic-logs

      - name: Run coverage checker (node)
        if: always()
        run: |
          echo "Running node coverage checker"
          node scripts/check-coverage.js --path coverage-artifacts --config coverage.config.json

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: audit-reports

  dast:
    name: DAST - OWASP ZAP baseline scan
    runs-on: ubuntu-latest
    needs: test
    env:
      # Comma-separated severities that should make the job fail (case-insensitive)
      ZAP_FAIL_SEVERITIES: "High,Critical"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure docker-compose and docker available
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin || true
          if [ -f /usr/libexec/docker/cli-plugins/docker-compose ]; then
            sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
          fi
          docker --version || true

      - name: Start test stack for DAST
        run: |
          echo "Starting docker-compose test stack for DAST..."
          docker-compose -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/docker-compose.test.yml up -d || docker-compose -f docker-compose.test.yml up -d || true

      - name: Wait for target to be healthy
        run: |
          TARGET_URL=http://localhost:3003/health
          METRICS_URL=http://localhost:9410/metrics || true
          echo "Waiting for $TARGET_URL to respond (timeout 120s)..."
          for i in $(seq 1 24); do
            if curl -sSf $TARGET_URL >/dev/null 2>&1; then
              echo "Target healthy"
              break
            fi
            sleep 5
          done
          # final check
          if ! curl -sSf $TARGET_URL >/dev/null 2>&1; then
            echo "Target did not become healthy" && exit 1
          fi
          # optional: check metrics endpoint presence
          if curl -sSf $METRICS_URL >/dev/null 2>&1; then
            echo "Metrics endpoint available at $METRICS_URL"
          else
            echo "Metrics endpoint not available at $METRICS_URL (ok if not configured)"
          fi

      - name: Try Action-based OWASP ZAP baseline (portable)
        id: zap_action
        uses: zaproxy/action-baseline@v0.6.0
        with:
          target: 'http://localhost:3003'
        continue-on-error: true

      - name: "Fallback: Run OWASP ZAP baseline scan (container, host network)"
        if: steps.zap_action.outcome != 'success'
        run: |
          echo "Running OWASP ZAP baseline scan (fallback) against http://localhost:3003"
          # generate both HTML and JSON reports (-r html, -J json)
          # keep the docker run on a single line to avoid YAML parsing issues
          docker run --rm --network host -v "$PWD":/zap/wrk/:rw owasp/zap2docker-stable zap-baseline.py -t http://localhost:3003 -r zap-report.html -J zap-report.json || true

      - name: Analyze ZAP JSON and fail on configured severities
        id: analyze
        if: always()
        continue-on-error: true
        run: |
          echo "Inspecting zap-report.json for severities in $ZAP_FAIL_SEVERITIES..."
            python3 - <<'PY'
            import json,sys,os
            path='zap-report.json'
            if not os.path.exists(path):
              print('zap-report.json not found, skipping fail-on-alerts check')
              sys.exit(0)
            with open(path,'r',encoding='utf-8') as f:
              try:
                j=json.load(f)
              except Exception as e:
                print('Failed to parse zap-report.json:',e)
                sys.exit(0)

            severities_env = os.environ.get('ZAP_FAIL_SEVERITIES','High,Critical')
            severities = set([s.strip().lower() for s in severities_env.split(',') if s.strip()])
            print('Configured fail severities:', severities)

            def scan(obj):
              # Prefer explicit 'risk' fields typical in ZAP JSON
              if isinstance(obj, dict):
                if 'risk' in obj and isinstance(obj['risk'], str):
                  if obj['risk'].strip().lower() in severities:
                    return True, ('risk', obj['risk'], obj)
                for v in obj.values():
                  found = scan(v)
                  if found[0]:
                    return found
              elif isinstance(obj, list):
                for item in obj:
                  found = scan(item)
                  if found[0]:
                    return found
              elif isinstance(obj, str):
                low = obj.lower()
                for sev in severities:
                  if sev in low:
                    return True, (None, obj, obj)
              return (False, None)

            found = scan(j)
            if found[0]:
              print('Failing build due to alert:', found[1])
              sys.exit(1)
            else:
              print('No configured-severity alerts found in zap-report.json')
              sys.exit(0)
            PY

      - name: Upload ZAP report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap-report.html
            zap-report.json

      - name: Create GitHub issue for DAST findings
        if: steps.analyze.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'zap-report.json';
            let body = `DAST (OWASP ZAP) found alerts in run ${process.env.GITHUB_RUN_ID} for repository ${process.env.GITHUB_REPOSITORY}.\n\n`;
            if (fs.existsSync(path)) {
              try {
                const j = JSON.parse(fs.readFileSync(path, 'utf8'));
                body += 'Summary (first matching alert):\n\n';
                // Try to find first alert with risk field
                function find(obj) {
                  if (!obj) return null;
                  if (typeof obj === 'object') {
                    if (obj.risk) return obj;
                    for (const k of Object.keys(obj)) {
                      const found = find(obj[k]);
                      if (found) return found;
                    }
                  }
                  return null;
                }
                const found = find(j);
                if (found) {
                  body += 'Risk: ' + (found.risk || 'unknown') + '\n';
                  body += 'Alert: ' + (found.name || JSON.stringify(found).slice(0,200)) + '\n\n';
                }
              } catch (e) {
                body += 'Could not parse zap-report.json: ' + e.toString() + '\n\n';
              }
            }
            body += `Download artifacts for full report: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `DAST findings: ${process.env.GITHUB_REPOSITORY} run ${process.env.GITHUB_RUN_ID}`,
              body: body,
            });
            core.setOutput('issue_number', issue.data.number);

      - name: Tear down docker-compose test stack
        if: always()
        run: |
          docker-compose -f Backend-Huancavelica-Alertas-Agricolas/services/rest-service/docker-compose.test.yml down -v || docker-compose -f docker-compose.test.yml down -v || true

  build-and-deploy:
    name: Build and Deploy to AWS (ECR/ECS)
    runs-on: ubuntu-latest
    needs: [test, dast]
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (via OIDC role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::876253813400:role/pat-ah-github-actions-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache npm registry
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies for all services
        run: |
          services=(auth-service users-service rest-service ai-service ingest-service)
          for s in "${services[@]}"; do
            pkg="Backend-Huancavelica-Alertas-Agricolas/services/$s"
            if [ -f "$pkg/package.json" ]; then
              echo "--- Installing dependencies for $s ---"
              if [ -f "$pkg/package-lock.json" ]; then
                npm ci --prefix "$pkg" || npm install --prefix "$pkg"
              else
                npm install --prefix "$pkg"
              fi
            fi
          done

      - name: Run tests per service (if present)
        run: |
          services=(auth-service users-service rest-service ai-service ingest-service)
          for s in "${services[@]}"; do
            pkg="Backend-Huancavelica-Alertas-Agricolas/services/$s"
            if [ -f "$pkg/package.json" ]; then
              echo "--- Running tests for $s ---"
              npm run test --prefix "$pkg" --if-present || true
            fi
          done

      - name: Login to ECR
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

      - name: Build, tag (SHA) and push images
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          SERVICES=(auth-service users-service rest-service ai-service ingest-service)
          REPO_ROOT="${GITHUB_WORKSPACE}"
          BACKEND_PATH="$REPO_ROOT/Backend-Huancavelica-Alertas-Agricolas"
          for s in "${SERVICES[@]}"; do
            image=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pat-ah-$s:${IMAGE_TAG}
            echo "Building $s -> $image"
            docker build -t "pat-ah-$s:${IMAGE_TAG}" -f "$BACKEND_PATH/services/$s/Dockerfile" "$BACKEND_PATH"
            docker tag "pat-ah-$s:${IMAGE_TAG}" "$image"
            docker push "$image"
            # Also update the 'latest' tag (optional)
            docker tag "pat-ah-$s:${IMAGE_TAG}" ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pat-ah-$s:latest || true
            docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pat-ah-$s:latest || true
          done

      - name: Register new task definition revisions and update ECS services
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          apt-get update && apt-get install -y jq
          SERVICES=(auth-service users-service rest-service ai-service ingest-service)
          for s in "${SERVICES[@]}"; do
            svc_name="pat-ah-$s"
            echo "Processing ECS service: $svc_name"
            td_arn=$(aws ecs describe-services --cluster pat-ah-cluster --services $svc_name --query 'services[0].taskDefinition' --output text --region $AWS_REGION)
            echo "Current task definition: $td_arn"
            td_json=$(aws ecs describe-task-definition --task-definition $td_arn --region $AWS_REGION --query 'taskDefinition')
            container_name="$s"
            new_image="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pat-ah-${s}:${IMAGE_TAG}"
            echo "New image for $container_name -> $new_image"
            new_td=$(echo "$td_json" | jq --arg cname "$container_name" --arg img "$new_image" '.containerDefinitions |= map(if .name == $cname then .image = $img else . end) | {family: .family, taskRoleArn: .taskRoleArn, executionRoleArn: .executionRoleArn, networkMode: .networkMode, containerDefinitions: .containerDefinitions, volumes: .volumes, placementConstraints: .placementConstraints, requiresCompatibilities: .requiresCompatibilities, cpu: .cpu, memory: .memory, pidMode: .pidMode, ipcMode: .ipcMode}')
            echo "$new_td" > new-taskdef.json
            reg_out=$(aws ecs register-task-definition --cli-input-json file://new-taskdef.json --region $AWS_REGION)
            new_td_arn=$(echo "$reg_out" | jq -r '.taskDefinition.taskDefinitionArn')
            echo "Registered new task def: $new_td_arn"
            aws ecs update-service --cluster pat-ah-cluster --service $svc_name --task-definition $new_td_arn --region $AWS_REGION
            echo "Updated service $svc_name to use $new_td_arn"
          done

      - name: Force ECS redeploy
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          SERVICES=(auth-service users-service rest-service ai-service ingest-service)
          for s in "${SERVICES[@]}"; do
            svc_name="pat-ah-$s"
            echo "Forcing redeploy for $svc_name"
            aws ecs update-service --cluster pat-ah-cluster --service $svc_name --force-new-deployment --region $AWS_REGION
          done

      - name: Done
        run: echo "CI/CD pipeline finished"

  deploy-frontend:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (via OIDC role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::876253813400:role/pat-ah-github-actions-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: PAT-AH/Frontend-Huancavelica-Alertas-Agricolas/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('PAT-AH/Frontend-Huancavelica-Alertas-Agricolas/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Build frontend (Vite)
        run: |
          FRONTEND_DIR="$GITHUB_WORKSPACE/Frontend-Huancavelica-Alertas-Agricolas"
          cd "$FRONTEND_DIR"
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps
          npm run build

      - name: Sync `dist/` to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          FRONTEND_DIST="$GITHUB_WORKSPACE/Frontend-Huancavelica-Alertas-Agricolas/dist"
          if [ -z "${S3_BUCKET}" ]; then
            echo "S3_BUCKET secret not set. Skipping frontend deployment.";
            exit 0;
          fi
          echo "Syncing $FRONTEND_DIST to s3://$S3_BUCKET"
          aws s3 sync "$FRONTEND_DIST" "s3://$S3_BUCKET" --delete --acl public-read

      - name: Invalidate CloudFront (optional)
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ -z "${CLOUDFRONT_DISTRIBUTION_ID}" ]; then
            echo "CLOUDFRONT_DISTRIBUTION_ID not set; skipping invalidation.";
            exit 0;
          fi
          set +e
          out=$(aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*" 2>&1)
          rc=$?
          if [ $rc -ne 0 ]; then
            echo "CloudFront invalidation failed:"
            echo "$out"
            echo "Continuing without failing the job."
          else
            echo "$out"
          fi
          set -e

      - name: Post-deploy verification (frontend)
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          if [ -n "${FRONTEND_URL}" ]; then
            url="${FRONTEND_URL}"
          else
            if [ -z "${S3_BUCKET}" ]; then
              echo "No FRONTEND_URL or S3_BUCKET provided; skipping verification.";
              exit 0;
            fi
            url="http://${S3_BUCKET}.s3-website-${AWS_REGION}.amazonaws.com"
          fi
          echo "Verifying frontend at $url"
          attempts=0
          max=8
          until [ $attempts -ge $max ]
          do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || true)
            echo "Attempt $((attempts+1)): HTTP $status"
            if [ "$status" = "200" ]; then
              echo "Frontend responded 200"
              exit 0
            fi
            attempts=$((attempts+1))
            sleep 5
          done
          echo "Frontend did not respond 200 after $max attempts"
          exit 1
